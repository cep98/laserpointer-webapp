<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laser Display v3.3</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      font-size: 14px;
    }
    #canvas {
      display: block;
      margin: auto;
      background: black;
    }
    #version {
      position: absolute;
      top: 6px;
      right: 10px;
      font-size: 12px;
      color: white;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div id="version">v3.3</div>
  <canvas id="canvas" width="1024" height="1024"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const maxAngle = 20;
    let points = [];
    let laserX = 512;
    let laserY = 512;
    let lastX = null;
    let lastY = null;
    let color = "#ff0000";
    let isDrawing = false;
    let isCalibrated = false;
    let alpha0 = 0;
    let beta0 = 0;

    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    socket.on("motion", ({ alpha, beta, color: c, isDrawing: draw }) => {
      if (typeof alpha !== "number" || typeof beta !== "number") return;

      if (c) color = c;
      if (draw !== undefined) isDrawing = draw;

      if (!isCalibrated && isDrawing) {
        alpha0 = alpha;
        beta0 = beta;
        isCalibrated = true;
      }

      const relAlpha = alpha - alpha0;
      const relBeta = beta - beta0;

      laserX = 512 + (relAlpha / maxAngle) * 512;
      laserY = 512 + (relBeta / maxAngle) * 512;

      // Begrenzen
      laserX = Math.max(0, Math.min(1023, laserX));
      laserY = Math.max(0, Math.min(1023, laserY));

      if (isDrawing) {
        if (lastX !== null && lastY !== null) {
          drawLine(lastX, lastY, laserX, laserY, color);
        }
        lastX = laserX;
        lastY = laserY;
      } else {
        lastX = null;
        lastY = null;
      }
    });

    socket.on("clear", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    function drawLine(x1, y1, x2, y2, color) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
    }

    function drawLaserDot() {
      if (!isDrawing) {
        const r = 6 + Math.sin(Date.now() / 150) * 2;
        ctx.beginPath();
        ctx.arc(laserX, laserY, r, 0, 2 * Math.PI);
        ctx.fillStyle = color;
        ctx.fill();
      }
      requestAnimationFrame(drawLaserDot);
    }

    drawLaserDot();
  </script>
</body>
</html>
