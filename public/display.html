<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Laserpointer Display v3.18</title>
  <style>
    body { margin:0; background:#000 }
    canvas { display:block; margin:auto; background:#000 }
    #version {
      position:absolute; top:10px; left:10px;
      color:#fff; font-family:sans-serif; font-size:14px; opacity:0.6;
    }
  </style>
</head>
<body>
  <div id="version">v3.18 (multi-user + brushes)</div>
  <canvas id="canvas" width="1024" height="1024"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.emit("identify",{ role:"display", deviceId:null });

    const c   = document.getElementById("canvas"),
          ctx = c.getContext("2d"),
          CX  = c.width/2, CY = c.height/2;

    let MAX_H=20, MAX_V=20, SMOOTH=0.15;
    socket.on("updateSettings",({maxH,maxV,smooth})=>{
      if(typeof maxH==="number") MAX_H=maxH;
      if(typeof maxV==="number") MAX_V=maxV;
      if(typeof smooth==="number") SMOOTH=smooth;
    });

    const alpha0   ={}, beta0   ={};

    const lastRaw  ={},   // deviceId→raw coords
          lastSm   ={},   // deviceId→sm coords
          lastCol  ={},   // deviceId→color
          lastLit  ={};   // deviceId→lightness

    ctx.lineCap  ="round";
    ctx.lineJoin ="round";

    socket.on("clear",()=>{
      ctx.clearRect(0,0,c.width,c.height);
      for(let k in alpha0)delete alpha0[k];
      for(let k in beta0 )delete beta0[k];
      for(let k in lastRaw)delete lastRaw[k];
      for(let k in lastSm )delete lastSm[k];
      for(let k in lastCol)delete lastCol[k];
      for(let k in lastLit)delete lastLit[k];
    });

    function parseLight(hsl){ const m=hsl.match(/hsl\(\s*\d+,\s*\d+%,\s*(\d+)%\s*\)/); return m?+m[1]:50; }

    function stamp(brush,x0,y0,x1,y1,color){
      const dx=x1-x0,dy=y1-y0,d=Math.hypot(dx,dy);
      if(d<1)return;
      const n=Math.ceil(d/6);
      for(let i=0;i<=n;i++){
        const t=i/n, x=x0+dx*t, y=y0+dy*t;
        ctx.fillStyle=color; ctx.strokeStyle=color;
        if(brush===1){
          ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill();
        }else if(brush===2){
          const a=Math.atan2(dy,dx);
          ctx.lineWidth=4;
          ctx.beginPath();
          ctx.moveTo(x-Math.cos(a)*7.5,y-Math.sin(a)*7.5);
          ctx.lineTo(x+Math.cos(a)*7.5,y+Math.sin(a)*7.5);
          ctx.stroke();
        }else if(brush===3){
          [ -5,5 ].forEach(dx0=>[ -5,5 ].forEach(dy0=>{
            ctx.beginPath(); ctx.arc(x+dx0,y+dy0,1.5,0,2*Math.PI); ctx.fill();
          }));
        }
      }
    }

    socket.on("motion",({alpha,beta,color,isDrawing,brush,deviceId})=>{
      if(!deviceId||typeof alpha!=="number")return;
      lastCol[deviceId]=color;
      lastLit[deviceId]=parseLight(color);

      if(isDrawing&&!(deviceId in alpha0)){
        alpha0[deviceId]=alpha;
        beta0 [deviceId]=beta;
      }
      if(!(deviceId in alpha0))return;

      let dA=alpha-alpha0[deviceId];
      if(dA>180)dA-=360;
      if(dA<-180)dA+=360;
      let dB=beta-beta0[deviceId];

      dA=Math.max(-MAX_H,Math.min(MAX_H,dA));
      dB=Math.max(-MAX_V,Math.min(MAX_V,dB));

      const rawX=CX-(dA/MAX_H)*CX,
            rawY=CY-(dB/MAX_V)*CY;
      lastRaw[deviceId]={x:rawX,y:rawY};

      if(!(deviceId in lastSm)) lastSm[deviceId]={x:CX,y:CY};
      const s=lastSm[deviceId];
      s.x+=(rawX-s.x)*SMOOTH;
      s.y+=(rawY-s.y)*SMOOTH;

      if(isDrawing){
        stamp(brush, s.x, s.y, s.x+(rawX-s.x), s.y+(rawY-s.y), color);
      }
    });

    let pulse=0,up=true;
    (function drawLoop(){
      pulse += up?0.2:-0.2;
      if(pulse>2)up=false;
      if(pulse<0)up=true;

      for(let id in lastSm){
        const {x,y}=lastSm[id],
              col=lastCol[id]||"#fff",
              r=4+pulse;
        ctx.beginPath(); ctx.arc(x,y,r,0,2*Math.PI);
        ctx.fillStyle=col; ctx.fill();
        if(lastLit[id]<20){
          ctx.beginPath(); ctx.arc(x,y,r+3,0,2*Math.PI);
          ctx.strokeStyle="#fff"; ctx.lineWidth=3; ctx.stroke();
        }
      }
      requestAnimationFrame(drawLoop);
    })();
  </script>
</body>
</html>
