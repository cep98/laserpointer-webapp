<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Laserpointer Display</title>
  <style>
    body { margin:0; background:#000; }
    canvas { display:block; margin:auto; background:#000; }
    #version{ position:absolute; top:10px; left:10px; color:#fff; opacity:0.6; }
  </style>
</head>
<body>
  <div id="version">v3.x (Canvas2D)</div>
  <canvas id="canvas" width="1024" height="1024"></canvas>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.emit("identify", { role:"display", deviceId:null });

    const canvas = document.getElementById("canvas"),
          ctx    = canvas.getContext("2d"),
          CX     = canvas.width/2,
          CY     = canvas.height/2;

    // Default-Settings (vom Admin überschrieben)
    let MAX_H = 20, MAX_V = 20, SMOOTH=0.15, MIN_W=5, MAX_W=12;

    socket.on("updateSettings", ({ maxH, maxV, smooth, minW, maxW }) => {
      if(typeof maxH==="number") MAX_H=safe(maxH);
      if(typeof maxV==="number") MAX_V=safe(maxV);
      if(typeof smooth==="number")SMOOTH=smooth;
      if(typeof minW==="number") MIN_W=minW;
      if(typeof maxW==="number") MAX_W=maxW;
    });
    function safe(n){ return isNaN(n)?20:n; }

    let alpha0={}, beta0={}, rawPos={}, smoothPos={}, lastTime={}, lastColor={}, lastLight={}, lastW={};

    function parseLight(hsl){
      const m = hsl.match(/hsl\(\s*\d+,\s*\d+%,\s*(\d+)%\)/);
      return m?+m[1]:50;
    }

    socket.on("clear",()=>{
      ctx.clearRect(0,0,1024,1024);
      [alpha0,beta0,rawPos,smoothPos,lastTime,lastColor,lastLight,lastW]
        .forEach(o=>Object.keys(o).forEach(k=>delete o[k]));
    });

    socket.on("motion",({alpha,beta,color,isDrawing,deviceId})=>{
      if(!deviceId||typeof alpha!=="number")return;
      const now=performance.now();
      lastColor[deviceId]=color;
      lastLight[deviceId]=parseLight(color);

      // Kalibrierung
      if(isDrawing && !(deviceId in alpha0)){
        alpha0[deviceId]=alpha; beta0[deviceId]=beta;
        rawPos[deviceId]={x:CX,y:CY};
        smoothPos[deviceId]={x:CX,y:CY,t:now};
        lastTime[deviceId]=now;
        lastW[deviceId]=(MIN_W+MAX_W)/2;
      }
      if(!(deviceId in alpha0))return;

      // Winkel-Delta + Wrap
      let dA=alpha-alpha0[deviceId];
      if(dA>180)dA-=360;
      if(dA<-180)dA+=360;
      let dB=beta-beta0[deviceId];
      dA=Math.max(-MAX_H,Math.min(MAX_H,dA));
      dB=Math.max(-MAX_V,Math.min(MAX_V,dB));

      // Map
      const x = CX-(dA/MAX_H)*CX;
      const y = CY-(dB/MAX_V)*CY;

      // smoothing
      const sp=smoothPos[deviceId];
      sp.x+=(x-sp.x)*SMOOTH; sp.y+=(y-sp.y)*SMOOTH;

      // speed
      const dt=(now-sp.t)/1000,
            dx=sp.x-rawPos[deviceId].x,
            dy=sp.y-rawPos[deviceId].y,
            speed= dt>0?Math.hypot(dx,dy)/dt:0;
      sp.t=now;

      rawPos[deviceId]={x,y};

      if(isDrawing){
        const norm=Math.min(1,speed/2000),
              w2  = MAX_W-(MAX_W-MIN_W)*norm,
              w1  = lastW[deviceId];
        // Stück zeichnen
        ctx.strokeStyle=color;
        ctx.lineWidth= w1;
        ctx.beginPath();
        ctx.moveTo(sp.x-(sp.x-x), sp.y-(sp.y-y));
        ctx.lineTo(sp.x, sp.y);
        ctx.stroke();
        lastW[deviceId]=w2;
      }

      // Puls-Punkt
      // (können wir genau wie vorher implementieren)
    });
  </script>
</body>
</html>
