
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Control v3.7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #colorButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
    .color {
      width: 30px;
      height: 30px;
      margin: 5px;
      border-radius: 50%;
      border: 2px solid white;
    }
    #laser {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      margin-top: 50px;
      touch-action: none;
    }
    .version {
      position: absolute;
      top: 10px;
      right: 20px;
      color: white;
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="version">v3.7</div>
  <div id="colorButtons"></div>
  <div id="laser"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const colors = ["red", "orange", "yellow", "green", "blue", "cyan", "magenta", "white", "gray", "lime"];
    let currentColor = colors[0];
    let isDrawing = false;
    let calibrated = false;
    let midAlpha = 0;
    let midBeta = 0;

    const canvasSize = 1024;
    let maxAngleH = 20;
    let maxAngleV = 20;

    const colorButtons = document.getElementById("colorButtons");
    colors.forEach(color => {
      const btn = document.createElement("div");
      btn.className = "color";
      btn.style.backgroundColor = color;
      btn.addEventListener("click", () => currentColor = color);
      colorButtons.appendChild(btn);
    });

    const laser = document.getElementById("laser");

    function requestPermissionIfNeeded() {
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission().then(response => {
          if (response === "granted") {
            window.addEventListener("deviceorientation", handleOrientation);
          }
        }).catch(console.error);
      } else {
        window.addEventListener("deviceorientation", handleOrientation);
      }
    }

    function handleOrientation(event) {
      if (!event.alpha || !event.beta) return;
      const alpha = event.alpha;
      const beta = event.beta;

      if (!calibrated) return;

      let dx = alpha - midAlpha;
      let dy = beta - midBeta;

      if (dx > 180) dx -= 360;
      if (dx < -180) dx += 360;

      const x = Math.max(0, Math.min(canvasSize, canvasSize / 2 + (dx / maxAngleH) * (canvasSize / 2)));
      const y = Math.max(0, Math.min(canvasSize, canvasSize / 2 + (dy / maxAngleV) * (canvasSize / 2)));

      socket.emit("draw", {
        x, y,
        color: currentColor,
        id: socket.id,
        isStart: isDrawing
      });
    }

    laser.addEventListener("touchstart", e => {
      e.preventDefault();
      if (!calibrated) {
        calibrated = true;
        return;
      }
      isDrawing = true;
    });

    laser.addEventListener("touchend", e => {
      e.preventDefault();
      isDrawing = false;
      socket.emit("drawend", socket.id);
    });

    socket.on("updateAngles", data => {
      if (data.maxH !== undefined) maxAngleH = data.maxH;
      if (data.maxV !== undefined) maxAngleV = data.maxV;
      console.log("Neue Winkelgrenzen:", maxAngleH, maxAngleV);
    });

    requestPermissionIfNeeded();
  </script>
</body>
</html>
