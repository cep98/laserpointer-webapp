<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laserpointer Control v3.3</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }
    #colorPicker {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 80vw;
    }
    .colorBtn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
    }
    #laserBtn {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      border: none;
      touch-action: none;
    }
    .version {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="colorPicker"></div>
  <button id="laserBtn"></button>
  <div class="version">v3.3</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket    = io();
    // Direkt als Control identifizieren
    socket.emit("identify", { role: "control", deviceId: socket.id });

    let isPressed   = false;
    let justStarted = false;
    let color       = 'red';

    // Farben definieren
    const colors = ['red','orange','yellow','green','blue','cyan','magenta','pink','white','gray'];
    const picker = document.getElementById("colorPicker");

    colors.forEach(c => {
      const btn = document.createElement("button");
      btn.className = "colorBtn";
      btn.style.backgroundColor = c;
      btn.addEventListener("click", () => {
        color = c;
        // Sofortiges Broadcasten des Farbwechsels
        socket.emit("color-change", { deviceId: socket.id, color });
      });
      picker.appendChild(btn);
    });

    const laserBtn = document.getElementById("laserBtn");

    function handleDraw(x, y) {
      socket.emit("draw", {
        x,
        y,
        color,
        isStart: justStarted
      });
      justStarted = false;
    }

    laserBtn.addEventListener("touchstart", e => {
      e.preventDefault();
      isPressed   = true;
      justStarted = true;
    });
    laserBtn.addEventListener("touchend", e => {
      e.preventDefault();
      isPressed   = false;
    });

    // Gyro-Bewegung
    let zeroAlpha = null, zeroBeta = null;
    const maxAngle = 20;
    window.addEventListener("deviceorientation", ev => {
      if (!isPressed) return;
      if (zeroAlpha === null) {
        zeroAlpha = ev.alpha;
        zeroBeta  = ev.beta;
      }
      let dA = ev.alpha - zeroAlpha;
      if      (dA > 180)  dA -= 360;
      else if (dA < -180) dA += 360;
      let dB = ev.beta - zeroBeta;

      dA = Math.max(-maxAngle, Math.min(maxAngle, dA));
      dB = Math.max(-maxAngle, Math.min(maxAngle, dB));

      const canvasX = (-dA + maxAngle) / (2*maxAngle) * 1024;
      const canvasY = (-dB + maxAngle) / (2*maxAngle) * 1024;
      handleDraw(canvasX, canvasY);
    });

    // iOS-Permission
    window.addEventListener("click", async () => {
      if (typeof DeviceOrientationEvent.requestPermission === "function") {
        try {
          const resp = await DeviceOrientationEvent.requestPermission();
          if (resp === "granted") console.log("Gyro OK");
        } catch(err) {
          console.error(err);
        }
      }
    });
  </script>
</body>
</html>
