<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Laserpointer Control – Final mit Freigabe</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      overflow: hidden;
      height: 100%;
    }
    canvas { display: none; }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
    }
    .color {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid white;
    }
    #laserButton {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20%;
      width: 120px;
      height: 120px;
      border-radius: 60px;
      background: red;
      border: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <canvas id="canvas" width="500" height="500"></canvas>
  <div id="controls">
    <div class="color" style="background:red" onclick="setColor('red')"></div>
    <div class="color" style="background:green" onclick="setColor('green')"></div>
    <div class="color" style="background:blue" onclick="setColor('blue')"></div>
    <div class="color" style="background:yellow" onclick="setColor('yellow')"></div>
  </div>
  <button id="laserButton"></button>

  <script>
    const socket = io();
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let color = "red";
    let laserActive = false;
    let calibrated = false;
    let alpha0 = 0, beta0 = 0;
    const sensitivity = 5;
    let edgeLock = null;

    let currentAlpha = null, currentBeta = null;
    let x = canvas.width / 2;
    let y = canvas.height / 2;

    function setColor(c) {
      color = c;
    }

    document.getElementById("laserButton").addEventListener("touchstart", e => {
      e.preventDefault();
      laserActive = true;
      if (!calibrated && currentAlpha !== null && currentBeta !== null) {
        alpha0 = currentAlpha;
        beta0 = currentBeta;
        calibrated = true;
      }
    });

    document.getElementById("laserButton").addEventListener("touchend", e => {
      e.preventDefault();
      laserActive = false;
    });

    function handleOrientation(e) {
      currentAlpha = e.alpha;
      currentBeta = e.beta;

      if (laserActive && calibrated) {
        let deltaX = (currentAlpha - alpha0) * sensitivity;
        let deltaY = (currentBeta - beta0) * sensitivity;

        let rawX = canvas.width / 2 - deltaX;
        let rawY = canvas.height / 2 - deltaY;

        let edgeHit = null;
        if (rawX <= 0) {
          x = 0;
          edgeHit = "left";
        } else if (rawX >= canvas.width) {
          x = canvas.width;
          edgeHit = "right";
        } else {
          x = rawX;
        }

        if (rawY <= 0) {
          y = 0;
          edgeHit = "top";
        } else if (rawY >= canvas.height) {
          y = canvas.height;
          edgeHit = "bottom";
        } else {
          y = rawY;
        }

        if (edgeHit) edgeLock = edgeHit;

        if (edgeLock === "left" && x > 30) {
          alpha0 = currentAlpha + (canvas.width / 2 - x) / sensitivity;
          edgeLock = null;
        }
        if (edgeLock === "right" && x < canvas.width - 30) {
          alpha0 = currentAlpha + (canvas.width / 2 - x) / sensitivity;
          edgeLock = null;
        }
        if (edgeLock === "top" && y > 30) {
          beta0 = currentBeta + (canvas.height / 2 - y) / sensitivity;
          edgeLock = null;
        }
        if (edgeLock === "bottom" && y < canvas.height - 30) {
          beta0 = currentBeta + (canvas.height / 2 - y) / sensitivity;
          edgeLock = null;
        }

        socket.emit("draw", { x, y, color });
      }
    }

    // Permission für iOS
    if (typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function") {
      DeviceOrientationEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === "granted") {
            window.addEventListener("deviceorientation", handleOrientation);
          } else {
            alert("Gyrosensor-Zugriff wurde nicht erlaubt.");
          }
        })
        .catch(console.error);
    } else {
      window.addEventListener("deviceorientation", handleOrientation);
    }

    socket.on("draw", data => {
      ctx.fillStyle = data.color;
      ctx.beginPath();
      ctx.arc(data.x, data.y, 4, 0, 2 * Math.PI);
      ctx.fill();
    });

    socket.on("clear", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  </script>
</body>
</html>
