<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Laserpointer Control â€“ Edge Locking</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      overflow: hidden;
      height: 100%;
    }
    canvas {
      display: none;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
    }
    .color {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid white;
    }
    #laserButton {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20%;
      width: 120px;
      height: 120px;
      border-radius: 60px;
      background: red;
      border: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <canvas id="canvas" width="500" height="500"></canvas>
  <div id="controls">
    <div class="color" style="background:red" onclick="setColor('red')"></div>
    <div class="color" style="background:green" onclick="setColor('green')"></div>
    <div class="color" style="background:blue" onclick="setColor('blue')"></div>
    <div class="color" style="background:yellow" onclick="setColor('yellow')"></div>
  </div>
  <button id="laserButton"></button>

  <script>
    const socket = io();
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let color = "red";
    let laserActive = false;
    let calibrated = false;
    let alpha0 = 0, beta0 = 0;
    const scaling = 5;

    let currentAlpha = null, currentBeta = null;
    let x = canvas.width / 2;
    let y = canvas.height / 2;

    let edgeLock = null;

    document.getElementById("laserButton").addEventListener("touchstart", e => {
      e.preventDefault();
      laserActive = true;
      if (!calibrated && currentAlpha !== null && currentBeta !== null) {
        alpha0 = currentAlpha;
        beta0 = currentBeta;
        calibrated = true;
      }
    });

    document.getElementById("laserButton").addEventListener("touchend", e => {
      e.preventDefault();
      laserActive = false;
    });

    function setColor(c) {
      color = c;
    }

    window.addEventListener("deviceorientation", e => {
      currentAlpha = e.alpha;
      currentBeta = e.beta;

      if (laserActive && calibrated) {
        let relAlpha = currentAlpha - alpha0;
        let relBeta = currentBeta - beta0;

        let rawX = canvas.width / 2 - relAlpha * scaling;
        let rawY = canvas.height / 2 - relBeta * scaling;

        // Check for edge lock activation
        if (!edgeLock) {
          if (rawX <= 0) {
            edgeLock = "left";
            x = 0;
          } else if (rawX >= canvas.width) {
            edgeLock = "right";
            x = canvas.width;
          } else if (rawY <= 0) {
            edgeLock = "top";
            y = 0;
          } else if (rawY >= canvas.height) {
            edgeLock = "bottom";
            y = canvas.height;
          } else {
            x = rawX;
            y = rawY;
          }
        }

        // If locked, wait for return movement to recalibrate
        if (edgeLock === "left" && rawX > 30) {
          alpha0 = currentAlpha + canvas.width / 2 / scaling;
          edgeLock = null;
        } else if (edgeLock === "right" && rawX < canvas.width - 30) {
          alpha0 = currentAlpha - canvas.width / 2 / scaling;
          edgeLock = null;
        } else if (edgeLock === "top" && rawY > 30) {
          beta0 = currentBeta + canvas.height / 2 / scaling;
          edgeLock = null;
        } else if (edgeLock === "bottom" && rawY < canvas.height - 30) {
          beta0 = currentBeta - canvas.height / 2 / scaling;
          edgeLock = null;
        }

        if (!edgeLock) {
          x = Math.max(0, Math.min(canvas.width, rawX));
          y = Math.max(0, Math.min(canvas.height, rawY));
        }

        socket.emit("draw", { x, y, color });
      }
    });

    socket.on("draw", data => {
      ctx.fillStyle = data.color;
      ctx.beginPath();
      ctx.arc(data.x, data.y, 4, 0, 2 * Math.PI);
      ctx.fill();
    });

    socket.on("clear", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  </script>
</body>
</html>
