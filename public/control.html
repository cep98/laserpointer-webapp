<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Laserpointer Control (Sticky Dynamic Calibration)</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      overflow: hidden;
      height: 100%;
    }
    #canvasContainer {
      position: relative;
      width: 100vmin;
      height: 100vmin;
      margin: auto;
      border: 1px solid #444;
      background: #000;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
    }
    .color {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid white;
    }
    #laserButton {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 25%;
      width: 80px;
      height: 80px;
      border-radius: 40px;
      background: red;
      border: none;
    }
  </style>
</head>
<body>
  <div id="canvasContainer">
    <canvas id="canvas" width="500" height="500"></canvas>
  </div>
  <div id="controls">
    <div class="color" style="background:red" onclick="setColor('red')"></div>
    <div class="color" style="background:green" onclick="setColor('green')"></div>
    <div class="color" style="background:blue" onclick="setColor('blue')"></div>
    <div class="color" style="background:yellow" onclick="setColor('yellow')"></div>
  </div>
  <button id="laserButton"></button>

  <script>
    const socket = io();
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let color = "red";
    let laserActive = false;
    let calibrated = false;
    let alpha0 = 0, beta0 = 0;
    let x = canvas.width / 2;
    let y = canvas.height / 2;

    const scaling = 5;
    const margin = 2; // Grenzbereich zum Umschalten

    document.getElementById("laserButton").addEventListener("touchstart", e => {
      e.preventDefault();
      laserActive = true;
      if (!calibrated && currentAlpha !== null && currentBeta !== null) {
        alpha0 = currentAlpha;
        beta0 = currentBeta;
        calibrated = true;
      }
    });

    document.getElementById("laserButton").addEventListener("touchend", e => {
      e.preventDefault();
      laserActive = false;
    });

    function setColor(c) {
      color = c;
    }

    let currentAlpha = null, currentBeta = null;

    window.addEventListener("deviceorientation", e => {
      currentAlpha = e.alpha;
      currentBeta = e.beta;

      if (laserActive && calibrated) {
        const relAlpha = currentAlpha - alpha0;
        const relBeta = currentBeta - beta0;

        let newX = canvas.width / 2 - relAlpha * scaling;
        let newY = canvas.height / 2 - relBeta * scaling;

        let recalibrated = false;

        if (newX < 0) {
          x = 0;
          alpha0 = currentAlpha + canvas.width / 2 / scaling;
          recalibrated = true;
        } else if (newX > canvas.width) {
          x = canvas.width;
          alpha0 = currentAlpha - canvas.width / 2 / scaling;
          recalibrated = true;
        } else {
          x = newX;
        }

        if (newY < 0) {
          y = 0;
          beta0 = currentBeta + canvas.height / 2 / scaling;
          recalibrated = true;
        } else if (newY > canvas.height) {
          y = canvas.height;
          beta0 = currentBeta - canvas.height / 2 / scaling;
          recalibrated = true;
        } else {
          y = newY;
        }

        socket.emit("draw", { x, y, color });
      }
    });

    socket.on("draw", data => {
      ctx.fillStyle = data.color;
      ctx.beginPath();
      ctx.arc(data.x, data.y, 4, 0, 2 * Math.PI);
      ctx.fill();
    });

    socket.on("clear", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  </script>
</body>
</html>
